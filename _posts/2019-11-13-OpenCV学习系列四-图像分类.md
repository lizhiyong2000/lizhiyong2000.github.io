---
layout: "post"
title: "OpenCV学习系列四-图像分类"
date: "2019-11-13 20:35"
categories: OpenCV
description: OpenCV学习系列四-图像分类
tags: OpenCV PyQT
---

* content
{:toc}

<div class="postImg" style="background-image:url(http://carforeasy.cn/OpenCV学习系列四-b431c6fd.png)" ></div>

> “OpenCV是一个开源的计算机视觉库，在这个OpenCV Python的教程中，我们将使用PyOpenCV库来学习OpenCV的基本功能，了解计算机视觉处理的基础知识，本文学习如何进行图像的简单分类。”





## 1. 图像分类概念

### 1.1 图像分类
图像分类是根据图像的不通特征将不同类别图像区分开来，是计算机视觉中重要的基本问题，也是图像检测、图像分割、物体跟踪、行为分析等其他高层视觉任务的基础。

一般来说，图像分类通过手工特征或特征学习方法对整个图像进行全部描述，然后使用分类器判别物体类别。本文将介绍使用SVM对图像进行简单分类。


### 1.2 基于SVM的图像分类

应用SVM进行分类的步骤如下：首先收集各个类的训练集和测试集，接着选择合适的用来分类的图像特征，从训练集中提取特征，然后用SVM分类器训练从而得到分类模板，最后通过模板对待分类图像进行分类。

[](http://carforeasy.cn/OpenCV学习系列四-b431c6fd.png)

## 2. 示例

### 2.1 加载测试图像

```python
def load_image(self):
     fname, _ = QFileDialog.getOpenFileName(self, 'Open file', './classify_data', "Image files (*.jpg *.png *.pgm)")

     if len(fname) > 0:
         self.image = cv2.imread(fname)

         demo_utils.show_cvimage_to_label(self.image, self.image_label)
         self.light_image = cv2.imread('./classify_data/pattern.pgm')

         self.threshold_image = classify_utils.preprocess_image(self.image, self.light_image)

         demo_utils.show_cvimage_to_label(self.threshold_image, self.threshold_label)

```

### 2.2 使用训练数据进行训练

```python
def prepare_data(self):

    training_list =[]
    responses_list = []
    test_list = []
    test_responses_list = []

    num_for_test= 20

    self.load_train_data("./classify_data/nut/tuerca_%04d.pgm", 0, num_for_test, training_list, responses_list, test_list, test_responses_list)
    self.load_train_data("./classify_data/ring/arandela_%04d.pgm", 1, num_for_test, training_list, responses_list, test_list, test_responses_list)
    self.load_train_data("./classify_data/screw/tornillo_%04d.pgm", 2, num_for_test, training_list, responses_list, test_list, test_responses_list)

    print("Num of train samples: %d " % len(responses_list))
    print("Num of test samples: %d " % len(test_responses_list))

    self.training_data = np.array([ x[0] for x in training_list] , dtype=np.float32)
    self.responses_data = np.array(responses_list, dtype=np.int32)

    self.test_data = np.array([ x[0] for x in test_list], dtype=np.float32)
    self.test_responses_data = np.array(test_responses_list, dtype=np.int32)
```


### 2.3 使用SVM进行分类

+ OpenCV提供的SVM


```python
def classify_cv_svm(self):

        self.svm = cv2.ml.SVM_create()
        self.svm.setType(cv2.ml.SVM_C_SVC)
        self.svm.setNu(0.05)
        self.svm.setKernel(cv2.ml.SVM_CHI2)
        self.svm.setDegree(1.0)

        # self.svm.setC(2.67)
        self.svm.setGamma(2.0)
        # TermCriteria(TermCriteria::MAX_ITER, 100, 1e-6));
        self.svm.setTermCriteria((cv2.TERM_CRITERIA_MAX_ITER, 100, 1.e-06))

        self.svm.train(self.training_data, cv2.ml.ROW_SAMPLE, self.responses_data)
        # self.svm.save('svm_data.dat')

        result = self.svm.predict(self.test_data)

        print(result[1].shape)

        print(self.test_responses_data.shape)

        # result = np.aarray(result, dtype=np.int32)

        result1 = np.array([x[0] for x in result[1]], dtype=np.int32)

        print(result1.shape)

        mask = result1 == self.test_responses_data
        correct = np.count_nonzero(mask)
        print("Accuracy cv svm: %0.4f" % (correct * 100.0 / len(result1)))
        output = self.image.copy()

        font = cv2.FONT_HERSHEY_SIMPLEX

        # fontScale
        fontScale = 0.5

        # Blue color in BGR
        color1 = (255, 0, 0)

        # Line thickness of 2 px
        thickness = 1

        self.features = classify_utils.extract_feautre(self.threshold_image)
        print(self.features)

        for i in range(0, len(self.features)):

            sample_data = np.array([self.features[i][0]], dtype=np.float32)

            # print(sample_data.shape)

            result = self.svm.predict(sample_data)

            print(self.features[i][0])
            print(result[1][0][0])

            label = int(result[1][0][0])

            org = (int(self.features[i][1][0]), int(self.features[i][1][1]))

            if label == 0:
                color = (255, 0, 0)
                text = "NUT"
            elif label == 1:
                color = (0, 255, 0)
                text = "RING"
            else:
                color = (0, 0, 255)
                text = "SCREW"

            output = cv2.putText(output, text, org, font,
                                 fontScale, color, thickness)

            demo_utils.show_cvimage_to_label(output, self.result_label)
```

+ sklearn提供的SVM

```python
def classify_sklearn_svm(self):

    svc = SVC()
    svc.fit(self.training_data, self.responses_data)

    predicted = svc.predict(self.test_data)
    print("Confusion matrix:\n%s" %
    metrics.confusion_matrix(self.test_responses_data,
                               predicted))
    print("Accuracy: %0.4f" % metrics.accuracy_score(self.test_responses_data,
                                                 predicted))

    output = self.image.copy()

    font = cv2.FONT_HERSHEY_SIMPLEX

    # fontScale
    fontScale = 0.5

    # Blue color in BGR
    color1 = (255, 0, 0)

    # Line thickness of 2 px
    thickness = 1

    self.features = classify_utils.extract_feautre(self.threshold_image)
    print(self.features)

    for i in range(0, len(self.features)):

        sample_data = np.array([self.features[i][0]], dtype=np.float32)

        # print(sample_data.shape)

        result = svc.predict(sample_data)

        print(self.features[i][0])
        print(result[0])

        label = int(result[0])

        org = (int(self.features[i][1][0]), int(self.features[i][1][1]))

        if label == 0:
            color = (255, 0, 0)
            text = "NUT"
        elif label == 1:
            color = (0, 255, 0)
            text = "RING"
        else:
            color = (0, 0, 255)
            text = "SCREW"

        output = cv2.putText(output, text, org, font,
                             fontScale, color, thickness)

        demo_utils.show_cvimage_to_label(output, self.result_label2)

```


运行程序，先加载待分类图像，然后进行分割：


![](http://carforeasy.cn/OpenCV学习系列四-d855fceb.png)

示例代码：[https://github.com/lizhiyong2000/tutorials/tree/master/OpenCVDemo](https://github.com/lizhiyong2000/tutorials/tree/master/OpenCVDemo)

## 3. 参考链接
+ [基于支持向量机的图像分类](https://blog.csdn.net/qq_32892383/article/details/79768684)
