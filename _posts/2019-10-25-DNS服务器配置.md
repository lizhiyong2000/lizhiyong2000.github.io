---
layout: "post"
title: "DNS服务器配置"
date: "2019-10-25 12:15"
categories: 操作系统
description: DNS服务器配置
tags: bind DNS
---

* content
{:toc}

<div class="postImg" style="background-image:url(http://carforeasy.cn/DNS服务器配置-838e356c.png)"></div>
> “BIND（Berkeley internet Name Daemon)也叫做NAMED，是现今互联网上使用最为广泛的DNS服务器程序。这篇文章将要讲述如何在chroot 监牢中运行 BIND，以及配置BIND支持IPv6。”





## 1. 软件包安装

### 1.1 安装

```
yum -y install bind-chroot bind-utils
```

### 1.2 准备配置文件及目录

```
cp -R /usr/share/doc/bind-*/sample/var/named/* /var/named/chroot/var/named/

touch /var/named/chroot/var/named/data/cache_dump.db
touch /var/named/chroot/var/named/data/named_stats.txt
touch /var/named/chroot/var/named/data/named_mem_stats.txt
touch /var/named/chroot/var/named/data/named.run
mkdir /var/named/chroot/var/named/dynamic
touch /var/named/chroot/var/named/dynamic/managed-keys.bind

chmod -R 777 /var/named/chroot/var/named/data
chmod -R 777 /var/named/chroot/var/named/dynamic

cp -p /etc/named.conf /var/named/chroot/etc/
cp -p /etc/named.rfc1912.zones /var/named/chroot/etc/
cp -p /etc/named.root.key /var/named/chroot/etc/
cp -p /etc/named.iscdlv.key /var/named/chroot/etc/
```

### 1.3 启动测试

```
systemctl start named-chroot
systemctl enable named-chroot
```


## 2. 服务器配置

###  2.1 主配置文件

+ /var/named/chroot/etc/named.conf

  添加
  - 正向解析： zone "test.com" IN

  - 反向映射： zone "55.211.10.in-addr.arpa"



```
options {
        listen-on port 53 { any; };
        listen-on-v6 port 53 { ::1; };
        directory       "/var/named";
        dump-file       "/var/named/data/cache_dump.db";
        statistics-file "/var/named/data/named_stats.txt";
        memstatistics-file "/var/named/data/named_mem_stats.txt";
        recursing-file  "/var/named/data/named.recursing";
        secroots-file   "/var/named/data/named.secroots";
        allow-query     { localhost;10.211.55.0/24; };
        allow-query-cache     { localhost;10.211.55.0/24; };
        recursion no;

        /*
         - If you are building an AUTHORITATIVE DNS server, do NOT enable recursion.
         - If you are building a RECURSIVE (caching) DNS server, you need to enable
           recursion.
         - If your recursive DNS server has a public IP address, you MUST enable access
           control to limit queries to your legitimate users. Failing to do so will
           cause your server to become part of large scale DNS amplification
           attacks. Implementing BCP38 within your network would greatly
           reduce such attack surface
        */

        dnssec-enable yes;
        dnssec-validation yes;
        dnssec-lookaside auto;
        /* Path to ISC DLV key */
        bindkeys-file "/etc/named.iscdlv.key";

        managed-keys-directory "/var/named/dynamic";

        pid-file "/run/named/named.pid";
        session-keyfile "/run/named/session.key";
};

logging {
        channel default_debug {
                file "data/named.run";
                severity dynamic;
        };
};

zone "." IN {
        type hint;
        file "named.ca";
};
controls {
            inet 127.0.0.1 port 953
            allow {localhost; } keys {"rndc-key"; };
        };
include "/etc/rndc.key";
include "/etc/named.rfc1912.zones";
include "/etc/named.root.key";

zone "test.com" IN {
        type master;
        masterfile-format text;
        file "test.com.zone";
        also-notify { 10.211.55.22; };
        allow-transfer {
                localhost;
                10.211.55.22;
        };
};
zone "55.211.10.in-addr.arpa"{
        type master;
        masterfile-format text;
        file "55.211.10.in-addr.arpa.zone";
        also-notify { 10.211.55.22; };
        allow-transfer {
                localhost;
                10.211.55.22;
        };
};

```

###  2.2 域名解析配置

+ 正向解析

```
[aipaas@communication-001 ~]$ sudo  cat  /var/named/chroot/var/named/test.com.zone
$TTL 1D
@       IN SOA  dns1.test.com. root.test.com. (
                                        20190925        ; serial
                                        1D      ; refresh
                                        1H      ; retry
                                        1W      ; expire
                                        3H )    ; minimum
        NS      dns1.test.com.
        NS      dns2.test.com.
dns1     A       10.211.55.21
dns2     A       10.211.55.22
client   A       10.211.55.23

```

+ 反向解析

```
[aipaas@communication-001 ~]$ sudo  cat  /var/named/chroot/var/named/55.211.10.in-addr.arpa.zone
$TTL 1D
@       IN SOA  dns1.test.com. root.test.com. (
                                                                20190926        ;serial
                                                                1D      ;refresh
                                                                1H      ;retry
                                                                1W      ;expire
                                                                3H      );minimum
        NS      dns1.test.com.
        NS      dns2.test.com.
21     PTR     dns1.test.com.
22     PTR     dns2.test.com.
23     PTR     client.test.com.
```

###  2.2 备机配置

```
zone "test.com" IN {
        type slave;
        masterfile-format text;
        masters {10.211.55.21; };
        file "slaves/test.com.zone";
};
zone "55.211.10.in-addr.arpa" IN {
        type slave;
        masterfile-format text;
        masters {10.211.55.21; };
        file "slaves/55.211.10.in-addr.arpa.zone";
};

```

### 2.3 测试

修改系统DNS配置：

/etc/NetworkManager/NetworkManager.conf

```
[main]
dns=none
```

+ /etc/resolv.conf

```
search test.com
nameserver 10.211.55.21
nameserver 10.211.55.22
```

+ 域名测试

  - 正向

  ```
  [root@dns-1 chroot]# ping client.test.com
  PING client.test.com (10.211.55.23) 56(84) bytes of data.
  From dns1.test.com (10.211.55.21) icmp_seq=1 Destination Host Unreachable
  From dns1.test.com (10.211.55.21) icmp_seq=2 Destination Host Unreachable
  From dns1.test.com (10.211.55.21) icmp_seq=3 Destination Host Unreachable
  From dns1.test.com (10.211.55.21) icmp_seq=4 Destination Host Unreachable
  ```

  - 反向

  ```
  [root@dns-1 chroot]# nslookup  10.211.55.23
  23.55.211.10.in-addr.arpa       name = client.test.com.
  ```

## 3. DNS支持IPV6

### 3.1 配置DNS支持IPV6

+ 配置IPV6地址

```
IPV6_AUTOCONF=no
IPV6ADDR=2001:db8::21
IPV6PREFIX=64
```

+ named.conf文件

```
zone "0.0.0.0.0.0.0.0.8.b.d.0.1.0.0.2.ip6.arpa"{
        type master;
        masterfile-format text;
        file "0.0.0.0.0.0.0.0.8.b.d.0.1.0.0.2.ip6.arpa.zone";
        also-notify { 10.211.55.22; };
        allow-transfer {
                localhost;
                10.211.55.22;
        };
};
```


+ 正向解析

```
[aipaas@communication-001 ~]$ sudo  cat  /var/named/chroot/var/named/test.com.zone
$TTL 1D
@       IN SOA  dns1.test.com. root.test.com. (
                                        20190925        ; serial
                                        1D      ; refresh
                                        1H      ; retry
                                        1W      ; expire
                                        3H )    ; minimum
        NS      dns1.test.com.
        NS      dns2.test.com.
dns1     A       10.211.55.21
dns2     A       10.211.55.22
client   A       10.211.55.23

dns1     AAAA       2001:db8::21
dns2     AAAA       2001:db8::22
client   AAAA       2001:db8::23

```

+ 反向解析

```
[aipaas@communication-001 ~]$ sudo  cat  /var/named/chroot/var/named/0.0.0.0.0.0.0.0.8.b.d.0.1.0.0.2.ip6.arpa.zone
$TTL 1D
@       IN SOA  dns1.test.com. root.test.com. (
                                                                20190926        ;serial
                                                                1D      ;refresh
                                                                1H      ;retry
                                                                1W      ;expire
                                                                3H      );minimum
        NS      dns1.test.com.
        NS      dns2.test.com.
1.2.0.0.0.0.0.0.0.0.0.0.0.0.0.0     PTR     dns1.test.com.
2.2.0.0.0.0.0.0.0.0.0.0.0.0.0.0     PTR     dns2.test.com.
3.2.0.0.0.0.0.0.0.0.0.0.0.0.0.0     PTR     client.test.com.
```



### 3.2 测试


+ 配置DNS

  ```
  search test.com
  nameserver 10.211.55.21
  nameserver 2001:db8::21
  ````

+ 测试IPv6域名解析

  - 正向

  ```
  [root@dns-1 named]# ping6 client.test.com
  PING client.test.com(2001:db8::23 (2001:db8::23)) 56 data bytes
  From dns-1 (2001:db8::21) icmp_seq=1 Destination unreachable: Address unreachable
  From dns-1 (2001:db8::21) icmp_seq=2 Destination unreachable: Address unreachable
  From dns-1 (2001:db8::21) icmp_seq=3 Destination unreachable: Address unreachable
  From dns-1 (2001:db8::21) icmp_seq=4 Destination unreachable: Address unreachable
  ```

  - 反向

  ```
  [root@dns-1 chroot]# nslookup  2001:db8::23
  3.2.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.8.b.d.0.1.0.0.2.ip6.arpa        name = client.test.com.
  ```





## 4. 参考链接

+ [CentOS 7搭建DNS服务器，bind安装配置](https://blog.feehi.com/linux/678.html)
+ [bind配置工具rndc使用](https://www.jianshu.com/p/f08cf7cebf3f)
